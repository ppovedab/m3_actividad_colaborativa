---
title: "M3 Actividad Colaborativa"
author: "Pedro Poveda"
date: "November 13, 2017"
output: html_document
---

## Resumen

Este documento R Markdown describe las transformaciones realizadas sobre el siguiente dataset:

**Evolución de la pesca de bajura subastada en la CAE por puertos**

<https://www.europeandataportal.eu/data/es/dataset/http-datos-gob-es-catalogo-a16003011-evolucion-de-la-pesca-de-bajura-subastada-en-la-cae1>

## Creación del directorio de trabajo

```{r dir, echo=TRUE}
if (!file.exists("D:/practicas_R/m3_actividad_colaborativa")){
  dir.create("D:/practicas_R/m3_actividad_colaborativa")
}

setwd("D:/practicas_R/m3_actividad_colaborativa")

getwd()
```

## Descarga del fichero

Creamos el directorio de datos (si no existe) y descargamos el fichero.

```{r desc}
if (!file.exists("../datos")) {
 dir.create("../datos")
}

fileURL <- "http://www.nasdap.net/estadisticas/datos/Pesca_evolbajura_8516.csv"

download.file(fileURL,destfile="../datos/Pesca_evolbajura_8516.csv", method="auto")

list.files("../datos")
```

# Creación de la tabla

Una vez descargado el fichero, cargamos el dataset con la librería **knitr**.

Como el fichero contiene líneas extra al principio y al final, las descartamos usando la función **head** y la opción **skip**.

```{r table}
library(knitr)

pescaBajura <- head(read.table("../datos/Pesca_evolbajura_8516.csv",  skip = 1, row.names=NULL, sep=";", header=TRUE), -3)

head(pescaBajura)[1:5]
```

# Eliminación de X en headers

Quitamos la **X** de los headers de Año con **gsub** y convertimos el resto a minúsculas.

```{r gsub}
names(pescaBajura) <- tolower(gsub("X","",names(pescaBajura)))

names(pescaBajura)
```

## Trim y conversión de campos numéricos

Los campos numéricos vienen con espacios en blanco. Con un **loop** los recorremos y hacemos **trim** y **class**.

```{r trim}
library(stringr)

for (i in 3:14) {
  pescaBajura[[i]] <- str_trim(pescaBajura[[i]])
  class(pescaBajura[[i]]) <- "numeric"
}
```


## Unpivot 

Con la función **melt** de la librería **reshape2** hacemos el unpivot de las columnas de año, asignándoles además un nuevo nombre (**anio** y **valor**)

```{r unpivot}
library(reshape2)

pescaBajuraUnpivot <- melt(pescaBajura, id.vars=c("unitatea.unidad","portuak.puertos"), variable.name = "anio", value.name = "valor")

head(pescaBajuraUnpivot)
```

## Escritura del dataset en fichero

Creamos el directorio de escritura (si no existe) y escribimos el dataset obtenido en pasos anteriores.

```{r write}
if (!file.exists("../datos/output")) {
 dir.create("../datos/output")
 }
 
write.table(pescaBajuraUnpivot,file="../datos/output/pescaBajuraTidy.csv", sep=";")

list.files("../datos/output")
```

## Comprobación del fichero creado

Por último, comprobamos que el fichero se ha creado correctamente.

```{r check}
pescaBajuraTidyRead <- read.csv2("../datos/output/pescaBajuraTidy.csv")

head(pescaBajuraTidyRead)
```


